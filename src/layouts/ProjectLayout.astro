---
import BaseLayout from './BaseLayout.astro';
import { getLangFromUrl, useTranslations, getProjectsPath } from '@/i18n/utils';
import type { CollectionEntry } from 'astro:content';
import { ExternalLink, Github, ArrowLeft } from 'lucide-react';
import ReadingProgress from '@/components/react/ReadingProgress';
import Lightbox from '@/components/react/Lightbox';

interface Props {
  project: CollectionEntry<'projects'>;
}

const { project } = Astro.props;
const { title, description, date, tags, cover, liveUrl, repoUrl } = project.data;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const projectsPath = getProjectsPath(lang);
---

<BaseLayout title={`${title} | Astyan Martin`} description={description}>
  <!-- Hero Section -->
  <div class="relative w-full bg-gradient-to-br from-accent/5 via-background to-purple-500/5 border-b border-border">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Back link -->
      <a
        href={projectsPath}
        class="inline-flex items-center gap-2 text-foreground-secondary hover:text-accent transition-colors mb-8 group"
      >
        <ArrowLeft className="w-4 h-4 transition-transform group-hover:-translate-x-1" />
        {t('project.backToProjects')}
      </a>

      <header>
        <h1 class="text-4xl md:text-5xl font-bold text-foreground mb-6 leading-tight">{title}</h1>

        <div class="flex flex-wrap items-center gap-6 text-foreground-secondary">
          {date && (
            <time datetime={date} class="text-sm font-medium px-3 py-1 rounded-full bg-background-secondary border border-border">
              {date}
            </time>
          )}

          {
            tags.length > 0 && (
              <div class="flex flex-wrap gap-2">
                {tags.map((tag) => (
                  <span class="tag">{tag}</span>
                ))}
              </div>
            )
          }
        </div>

        <!-- Action buttons -->
        {
          (liveUrl || repoUrl) && (
            <div class="flex flex-wrap gap-3 mt-8">
              {liveUrl && (
                <a
                  href={liveUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-5 py-2.5 bg-accent text-white rounded-lg hover:bg-accent-hover transition-all shadow-lg shadow-accent/20 hover:scale-105 font-medium"
                >
                  <ExternalLink className="w-4 h-4" />
                  {t('project.liveDemo')}
                </a>
              )}
              {repoUrl && (
                <a
                  href={repoUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-5 py-2.5 bg-background border border-border rounded-lg hover:border-accent hover:text-accent transition-all hover:scale-105 font-medium"
                >
                  <Github className="w-4 h-4" />
                  {t('project.sourceCode')}
                </a>
              )}
            </div>
          )
        }
      </header>
    </div>
  </div>

  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Cover image (Commented out as per user feedback) -->
    <!-- {
      cover && (
        <div class="mb-12 rounded-2xl overflow-hidden shadow-2xl border border-border/50 max-w-3xl mx-auto">
          <img
            src={cover}
            alt={title}
            class="w-full h-auto object-cover"
            loading="eager"
          />
        </div>
      )
    } -->

    <!-- Content -->
    <div class="prose prose-lg mx-auto">
      <slot />
    </div>
  </article>
  </article>

  <style is:global>
    /* Force figure caption styling */
    .prose .figure-caption, .figure-caption {
      text-align: center !important;
      font-style: italic !important;
      font-size: 0.875rem !important; /* text-sm */
      color: rgb(var(--color-foreground-secondary)) !important;
      margin-top: 0.5rem !important;
      margin-bottom: 2rem !important;
      display: block !important;
    }
  </style>
  <ReadingProgress client:load />
  <Lightbox client:idle />

  <script>
    function setupLightbox() {
      const images = document.querySelectorAll('.prose img');
      images.forEach(img => {
        img.classList.add('cursor-zoom-in', 'transition-transform', 'hover:scale-[1.01]');
        img.addEventListener('click', () => {
          const event = new CustomEvent('open-lightbox', {
            detail: { 
              src: img.getAttribute('src'), 
              alt: img.getAttribute('alt') 
            }
          });
          window.dispatchEvent(event);
        });
      });
    }

    // Run on initial load
    setupLightbox();

    // Run on View Transition navigation
    document.addEventListener('astro:page-load', setupLightbox);
  </script>
</BaseLayout>
