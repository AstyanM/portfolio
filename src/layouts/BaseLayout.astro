---
import BaseHead from '@/components/astro/BaseHead.astro';
import Footer from '@/components/astro/Footer.astro';
import Header from '@/components/react/Header';
import '@/styles/global.css';
import { getLangFromUrl } from '@/i18n/utils';
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title: string;
  description?: string;
  image?: string;
  jsonLd?: Record<string, unknown>;
}

const { title, description, image, jsonLd } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang={lang} class="scroll-smooth">
  <head>
    <BaseHead title={title} description={description} image={image} lang={lang} jsonLd={jsonLd} />
    <ViewTransitions />
  </head>
  <body class="min-h-screen flex flex-col bg-background text-foreground">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-[100] focus:px-4 focus:py-2 focus:bg-accent focus:text-white focus:rounded-lg focus:shadow-lg">
      {lang === 'fr' ? 'Aller au contenu principal' : 'Skip to main content'}
    </a>
    <Header client:load lang={lang} currentPath={currentPath} transition:persist />
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    <Footer />

    <!-- Scroll animation observer -->
    <script>
      function initScrollAnimations() {
        const elements = document.querySelectorAll('.animate-on-scroll');

        if (elements.length === 0) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                observer.unobserve(entry.target);
              }
            });
          },
          {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px',
          }
        );

        elements.forEach((el) => {
          // Check if element is already in viewport on page load
          const rect = el.getBoundingClientRect();
          const isInViewport = rect.top < window.innerHeight && rect.bottom > 0;
          
          if (isInViewport) {
            // Immediately show elements that are already visible
            el.classList.add('is-visible');
          } else {
            // Observe elements below the fold
            observer.observe(el);
          }
        });
      }

      // Run on initial load
      initScrollAnimations();

      // Re-run after View Transitions
      document.addEventListener('astro:after-swap', initScrollAnimations);
    </script>
  </body>
</html>
