---
import BaseHead from '@/components/astro/BaseHead.astro';
import Footer from '@/components/astro/Footer.astro';
import Header from '@/components/react/Header';
import '@/styles/global.css';
import { getLangFromUrl } from '@/i18n/utils';
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title: string;
  description?: string;
  image?: string;
  jsonLd?: Record<string, unknown>;
}

const { title, description, image, jsonLd } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang={lang} class="scroll-smooth">
  <head>
    <BaseHead title={title} description={description} image={image} lang={lang} jsonLd={jsonLd} />
    <ViewTransitions />
  </head>
  <body class="min-h-screen flex flex-col bg-background text-foreground">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:fixed focus:top-4 focus:left-4 focus:z-[100] focus:px-4 focus:py-2 focus:bg-accent focus:text-white focus:rounded-lg focus:shadow-lg">
      {lang === 'fr' ? 'Aller au contenu principal' : 'Skip to main content'}
    </a>
    <Header client:load lang={lang} currentPath={currentPath} transition:persist />
    <main id="main-content" class="flex-1">
      <slot />
    </main>
    <Footer />

    <!-- Scroll animation observer -->
    <script>
      function initScrollAnimations() {
        const animateElements = document.querySelectorAll('.animate-on-scroll, .animate-on-scroll-blur');
        const staggerContainers = document.querySelectorAll('.stagger-children');
        const isMobile = window.innerWidth <= 768;
        const staggerDelay = isMobile ? 50 : 80;

        if (animateElements.length === 0 && staggerContainers.length === 0) return;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                observer.unobserve(entry.target);
              }
            });
          },
          {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px',
          }
        );

        const staggerObserver = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add('is-visible');
                const items = entry.target.querySelectorAll(
                  '.stagger-item, .stagger-item-left, .stagger-item-right, .stagger-item-scale'
                );
                items.forEach((item, i) => {
                  item.style.transitionDelay = `${i * staggerDelay}ms`;
                  item.classList.add('is-visible');
                });
                staggerObserver.unobserve(entry.target);
              }
            });
          },
          {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px',
          }
        );

        animateElements.forEach((el) => {
          const rect = el.getBoundingClientRect();
          const isInViewport = rect.top < window.innerHeight && rect.bottom > 0;
          if (isInViewport) {
            el.classList.add('is-visible');
          } else {
            observer.observe(el);
          }
        });

        staggerContainers.forEach((container) => {
          const rect = container.getBoundingClientRect();
          const isInViewport = rect.top < window.innerHeight && rect.bottom > 0;
          if (isInViewport) {
            container.classList.add('is-visible');
            const items = container.querySelectorAll(
              '.stagger-item, .stagger-item-left, .stagger-item-right, .stagger-item-scale'
            );
            items.forEach((item, i) => {
              item.style.transitionDelay = `${i * staggerDelay}ms`;
              item.classList.add('is-visible');
            });
          } else {
            staggerObserver.observe(container);
          }
        });
      }

      initScrollAnimations();
      document.addEventListener('astro:after-swap', initScrollAnimations);
    </script>

    <style is:global>
      ::view-transition-old(root) {
        animation: 0.25s ease-out both fade-out;
      }
      ::view-transition-new(root) {
        animation: 0.25s ease-out both fade-in;
      }
      @keyframes fade-out {
        to { opacity: 0; }
      }
      @keyframes fade-in {
        from { opacity: 0; }
      }
    </style>
  </body>
</html>
