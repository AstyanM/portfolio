---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ProjectGrid from '@/components/react/ProjectGrid';
import { getCollection } from 'astro:content';
import { getAssetUrl, getProjectPath, getProjectsPath, useTranslations } from '@/i18n/utils';
import { ArrowRight } from 'lucide-react';
import { motion } from 'framer-motion';

import TechStack from '@/components/astro/TechStack.astro';
import Timeline from '@/components/astro/Timeline.astro';
import ProjectSpotlight from '@/components/astro/ProjectSpotlight.astro';
import HeroBackground from '@/components/astro/HeroBackground.astro';
import Typewriter from '@/components/react/Typewriter';
import Contact from '@/components/astro/Contact.astro';

const allProjects = await getCollection('projects', ({ data }) => {
  return data.lang === 'fr' && !data.draft;
});

// Remove the spotlight project from the grid to avoid duplication
const spotlightSlug = 'simulateur-parcoursup';
const filteredProjectsList = allProjects.filter(p => !p.slug.includes(spotlightSlug));

// Sort by year+month (most recent first)
const projects = filteredProjectsList.sort((a, b) => {
  const yearA = a.data.year ?? 0;
  const yearB = b.data.year ?? 0;
  if (yearA !== yearB) return yearB - yearA;
  const monthA = a.data.month ?? 0;
  const monthB = b.data.month ?? 0;
  return monthB - monthA;
});

// Transform for ProjectGrid (showing 5 + CTA card)
const projectsData = projects.slice(0, 5).map((p) => ({
  slug: p.slug,
  title: p.data.title,
  description: p.data.cardDescription ?? p.data.description,
  tags: p.data.tags,
  href: getProjectPath(p.slug.split('/')[1], 'fr'),
  coverUrl: getAssetUrl(p.data.cover?.src),
}));

const t = useTranslations('fr');

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'Person',
  name: 'Astyan Martin',
  url: 'https://astyanm.github.io/portfolio/',
  jobTitle: "Étudiant en ingénierie",
  sameAs: [
    'https://github.com/AstyanMusic',
    'https://linkedin.com/in/astyan-music',
  ],
};
---

<BaseLayout title="Astyan Martin | Portfolio" jsonLd={jsonLd}>
  <!-- Hero Section -->
  <section class="relative pt-36 pb-20 md:pt-48 md:pb-28 overflow-hidden">
    <!-- Animated Background -->
    <HeroBackground />

    <!-- Background gradient overlay for text readability -->
    <div
      class="absolute inset-0 bg-gradient-to-b from-transparent via-background/50 to-background pointer-events-none"
    >
    </div>

    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 relative">
      <div class="max-w-3xl">
        <p class="text-accent font-medium mb-4 animate-on-scroll-blur">{t('hero.greeting')}</p>

        <h1
          class="font-display text-4xl md:text-5xl lg:text-7xl font-bold tracking-tight text-foreground mb-4 animate-slide-up"
        >
          Astyan Martin
        </h1>
        <div class="h-1 w-24 bg-accent rounded-full mb-6 animate-slide-up"></div>

        <div class="min-h-[100px] mb-8">
          <Typewriter
            client:visible
            text={t('hero.description')}
            speed={12}
            delay={300}
            className="text-lg md:text-xl text-foreground-secondary leading-relaxed"
          />
        </div>

        <div class="flex flex-wrap gap-4">
          <a
            href={getProjectsPath('fr')}
            class="animate-cta-entrance inline-flex items-center gap-2 px-6 py-3 bg-foreground text-background rounded-lg hover:bg-accent hover:text-white transition-all duration-300 font-medium"
          >
            {t('hero.cta')}
            <ArrowRight className="w-4 h-4" />
          </a>
        </div>
      </div>
    </div>
  </section>

  <TechStack lang="fr" />
  <Timeline lang="fr" />

  <!-- Featured Projects Section -->
  <section class="pt-16 pb-20 md:pt-20 md:pb-28 animate-on-scroll bg-background-secondary/30">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

      <div class="mb-14">
        <ProjectSpotlight lang="fr" />
      </div>

      <div class="mb-8">
        <h2 class="text-3xl font-bold font-display text-foreground mb-2">{t('projects.otherTitle')}</h2>
        <p class="text-foreground-secondary">{t('projects.subtitle')}</p>
      </div>

      <ProjectGrid
        client:visible
        projects={projectsData}
        lang="fr"
        showFilter={false}
        mobileLimit={2}
        ctaCard={{ href: getProjectsPath('fr') }}
      />
    </div>
  </section>

  <Contact lang="fr" />
</BaseLayout>
