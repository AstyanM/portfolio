---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ProjectsPageClient from '@/components/react/ProjectsPageClient';
import { getCollection } from 'astro:content';
import { getAssetUrl, getProjectPath } from '@/i18n/utils';

const allProjects = await getCollection('projects', ({ data }) => {
  return data.lang === 'en' && !data.draft;
});

// Sort by year (most recent first)
const projects = allProjects.sort((a, b) => {
  const yearA = a.data.year ?? 0;
  const yearB = b.data.year ?? 0;
  return yearB - yearA;
});

// Calculate year counts for timeline
const yearCounts = projects.reduce((acc, p) => {
  const year = p.data.year ?? 0;
  acc[year] = (acc[year] || 0) + 1;
  return acc;
}, {} as Record<number, number>);

const years = Object.entries(yearCounts)
  .map(([year, count]) => ({ year: parseInt(year), count }))
  .sort((a, b) => a.year - b.year);

// Transform for ProjectGrid
const projectsData = projects.map((p) => ({
  slug: p.slug,
  title: p.data.title,
  description: p.data.cardDescription ?? p.data.description,
  tags: p.data.tags,
  href: getProjectPath(p.slug.split('/')[1], 'en'),
  coverUrl: getAssetUrl(p.data.cover?.src),
  repoUrl: p.data.repoPrivate ? undefined : p.data.repoUrl,
  year: p.data.year,
}));
---

<BaseLayout
  title="Projects | Astyan Martin"
  description="Discover my projects in engineering, AI, electronics and web development."
>
  <section class="pt-32 pb-16 md:pt-40 md:pb-24">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="mb-12">
        <h1 class="text-4xl font-bold font-display text-foreground mb-4">My Projects</h1>
        <p class="text-lg text-foreground-secondary">
          A selection of technical projects combining exploration and innovation. Filter by year or technology to find what interests you.
        </p>
      </div>

      <ProjectsPageClient client:visible years={years} projects={projectsData} lang="en" />
    </div>
  </section>
</BaseLayout>
