---
import { getAlternateUrl, getAlternateLang } from '@/i18n/utils';
import type { Lang } from '@/i18n/ui';

interface Props {
  title: string;
  description?: string;
  image?: string;
  lang?: 'fr' | 'en';
  jsonLd?: Record<string, unknown>;
}

const {
  title,
  description = "Portfolio d'Astyan Martin - Projets en ing\u00e9nierie, IA et \u00e9lectronique",
  image = '/portfolio/og-image.png',
  lang = 'en',
  jsonLd,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const base = import.meta.env.BASE_URL.replace(/\/$/, '');
const altLang = getAlternateLang(lang as Lang);
const altUrl = getAlternateUrl(Astro.url, altLang, Astro.site);
const currentUrl = getAlternateUrl(Astro.url, lang as Lang, Astro.site);
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#ffffff" />
<link rel="icon" type="image/svg+xml" href={`${base}/favicon.svg`} />
<meta name="generator" content={Astro.generator} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- RSS Feed -->
<link rel="alternate" type="application/rss+xml" title="Astyan Martin | Portfolio" href={`${base}/rss.xml`} />

<!-- Hreflang alternates -->
<link rel="alternate" hreflang={lang} href={currentUrl} />
<link rel="alternate" hreflang={altLang} href={altUrl} />
<link rel="alternate" hreflang="x-default" href={currentUrl} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<meta name="author" content="Astyan Martin" />
<html lang={lang} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={new URL(image, Astro.url)} />
<meta property="og:locale" content={lang === 'fr' ? 'fr_FR' : 'en_US'} />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={new URL(image, Astro.url)} />

<!-- JSON-LD Structured Data -->
{jsonLd && (
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
)}

<!-- Theme initialization script (avoid FOUC) -->
<script is:inline>
  /* Inline script to set theme immediately to avoid FOUC */
  const setMode = () => {
    const theme = (() => {
      if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
        return localStorage.getItem('theme');
      }
      return 'light';
    })();

    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }

    const themeColorMeta = document.querySelector('meta[name="theme-color"]');
    if (themeColorMeta) {
      themeColorMeta.setAttribute('content', theme === 'dark' ? '#0a0a0a' : '#ffffff');
    }
  };

  setMode();

  // Copy dark class to new document BEFORE swap to prevent flash
  document.addEventListener('astro:before-swap', (event) => {
    const isDark = document.documentElement.classList.contains('dark');
    if (isDark) {
      event.newDocument.documentElement.classList.add('dark');
    }
  });

  document.addEventListener('astro:after-swap', setMode);
</script>
