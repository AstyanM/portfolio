---
interface Props {
  title: string;
  description?: string;
  image?: string;
  lang?: 'fr' | 'en';
}

const {
  title,
  description = "Portfolio d'Astyan Martin - Projets en ingénierie, IA et électronique",
  image,
  lang = 'en',
} = Astro.props;

// Determine OG Image URL
let ogImage = image;
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

if (!ogImage) {
  // Check if we are on a project page
  const pathname = Astro.url.pathname;
  const isProject = pathname.includes('/projects/');
  
  if (isProject) {
    // Extract lang and project slug from URL: /portfolio/fr/projects/slug -> fr, slug
    const parts = pathname.split('/').filter(Boolean);
    // parts might be: ['portfolio', 'fr', 'projects', 'my-project']
    // Find the index of 'projects' and get lang (before it) and slug (after it)
    const projectsIndex = parts.indexOf('projects');
    const langFromPath = projectsIndex > 0 ? parts[projectsIndex - 1] : lang;
    const projectSlug = parts[parts.length - 1];
    ogImage = new URL(`${base}/og/${langFromPath}/${projectSlug}.png`, Astro.site).toString();
  } else {
    // Default dynamic OG
    ogImage = new URL(`${base}/og/default-${lang}.png`, Astro.site).toString();
  }
} else if (!image.startsWith('http')) {
    // Handle static relative images
    ogImage = new URL(image, Astro.site).toString();
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!-- Global Metadata -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" type="image/svg+xml" href={`${base}/favicon.svg`} />
<meta name="generator" content={Astro.generator} />

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
  rel="stylesheet"
/>

<!-- Canonical URL -->
<link rel="canonical" href={canonicalURL} />

<!-- Primary Meta Tags -->
<title>{title}</title>
<meta name="title" content={title} />
<meta name="description" content={description} />
<meta name="author" content="Astyan Martin" />
<html lang={lang} />

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content={Astro.url} />
<meta property="og:title" content={title} />
<meta property="og:description" content={description} />
<meta property="og:image" content={ogImage} />
<meta property="og:locale" content={lang === 'fr' ? 'fr_FR' : 'en_US'} />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={Astro.url} />
<meta property="twitter:title" content={title} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={ogImage} />

<!-- Theme initialization script (avoid FOUC) -->
<script is:inline>
  /* Inline script to set theme immediately to avoid FOUC */
  const setMode = () => {
    const theme = (() => {
      if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
        return localStorage.getItem('theme');
      }
      return 'light';
    })();
  
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  };

  setMode();
  document.addEventListener('astro:after-swap', setMode);
</script>
